<!DOCTYPE html>
<html>

<head>
    <title> OilRigs Life Cycle Prediction </title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://maps.google.com/maps/api/js?sensor=false&key=AIzaSyAQ779ww2LNyXCSHmFuw2EziA7CJDsu76c" type="text/javascript"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script type="text/javascript" src="js/jquery.maphilight.js"></script>
    <script src="js/qtip.js"> </script>
    <link rel="stylesheet" type="text/css" href="css/qtip.css" />
    <style>

        html,
        body {
            margin: 0;
            padding: 0;
            background:#F2F2F2;

        }

    .loader {
      border: 16px solid #f3f3f3;
      border-radius: 50%;
      border-top: 16px solid #3498db;
      border-bottom: 16px solid #3498db;
      width: 120px;
      height: 120px;
      -webkit-animation: spin 2s linear infinite;
      -moz-animation: spin 2s linear infinite;
      -ms-animation: spin 2s linear infinite;
      -o-animation: spin 2s linear infinite;
      animation: spin 2s linear infinite;
      position: fixed;
      top:30%;
      left: 50%;
      z-index: 1;
    }

    @-webkit-keyframes spin {
      0% { -webkit-transform: rotate(0deg); }
      100% { -webkit-transform: rotate(360deg); }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    </style>
</head>

<body>
    <div class="main-container" style="padding:0px 10px 10px;background:#F2F2F2;">

        <!--<div class="navbar row" role="navigation" style='height: 68px;background-color: #1976d2;margin:0 1%'>
            <div class="">
                     <h1 class="text-center" style='color:white;'>  OilRig Life Cycle Predictions </h1>
                
            </div>
        </div> -->

        <div class="navbar navbar-inverse navbar-fixed-top" role="navigation"> 
            <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" style="color: white" href="./map.html">  OilRig Life Cycle Predictions </a>
            </div>
        
            </div>

        </div> 
        <div class="loader" style="display: none;"></div> 

        <div style="margin-top: 5%;background:#F2F2F2;" class='row' > <!-- Removed display flex -->            

            <div class="col-md-6">

                <div id="map" style="width:680px;height:650px;margin-left:1.9%"></div>
            </div>

    	    <div style="margin-left:4.3%" id='oilRig' class='col-md-4'>
    		    <div>
                    <img src="images/oilrig1.jpg" width="550" height="650" class="map" usemap="#sensormap"/>
                    <h1 style="text-align:center;" id="img_desc"> </h1>
                </div>
            </div>
	   

        </div>
    </div>

    <map name="sensormap">
    <area alt="Crown Block" shape="circle" coords="259,24,9.8" href="" class="circle" id="a" data-maphilight='{"alwaysOn": false,"stroke":false,"fillColor":"62ce54","fillOpacity":1}'/>
    <area alt="Traveling Block" shape="circle" coords="256,283,9.8" href="" class="circle" id="o" data-maphilight='{"alwaysOn": false,"stroke":false,"fillColor":"62ce54","fillOpacity":1}'/>

    <area alt="Top Drive" shape="circle" coords="255,311,9.8" href="" class="circle" id="n" data-maphilight='{"alwaysOn": false,"stroke":false,"fillColor":"62ce54","fillOpacity":1}'/>

    </map>

        <script>
    	var deviceName;
    	var latitude;
    	var longtitude;
        var rulValues = [];
            $(document).ready(function() {

                var getOilRigs = function getOilRigs() {
                    var map = new google.maps.Map(document.getElementById('map'), {
                        zoom: 2,
                        center: new google.maps.LatLng(27, -85),
                        mapTypeId: google.maps.MapTypeId.ROADMAP
                    });


                    function getOilRigsLocation() {
    		    var durationInMins = 30; // in mins
                        var locationsjson = $.ajax({
                            type: "GET",
                            url: '/getOilRigs?durationInMins='+durationInMins,
                            async: false
                        }).responseText;
                        var locations = eval('(' + locationsjson + ')');
                        return locations;
                    }

                    var OilRigLocationObjects = getOilRigsLocation();
                    var locationsdata = [];

                    for (var i in OilRigLocationObjects) {
                        var OilRigLocationObject = OilRigLocationObjects[i];
                        var arrayelement = [];
                        if (typeof OilRigLocationObject === "object") {
                            for (var j in OilRigLocationObject) {
                                var temp = [];
                                var myitem = OilRigLocationObject[j];
                                if (typeof myitem === "object") {
                                    for (var k in myitem)
                                        temp.push(myitem[k]);
                                }
                                arrayelement.push(temp);
                            }
                        }
                        if (arrayelement.length) {
                            locationsdata.push(arrayelement);
                        }
                    }
                    var locations = locationsdata[0];
                    var marker, i;
                    var infowindow = new google.maps.InfoWindow();
                    var totalDeviceCount = locations.length;
                    
                    for (var i = 0; i < totalDeviceCount ; i++) {
                        
                        marker = new google.maps.Marker({
                            icon: "http://maps.google.com/mapfiles/ms/micons/green.png",
                            position: new google.maps.LatLng(locations[i][1], locations[i][2]),
                            map: map
                        });
                        google.maps.event.addListener(marker, 'mouseover', (function(marker, i) {
                            return function() {
                                infowindow.setContent(locations[i][0] );
                                infowindow.open(map, marker);
                            }
                        })(marker, i));
                        google.maps.event.addListener(marker, 'click', (function(marker, i) {
                            return function() {
                                $(".loader").css('display','block');
                				deviceName = locations[i][0];
                				latitude = locations[i][1];
                				longtitude = locations[i][2]; 
                                get_device_lifecycle();
                            }
                        })(marker, i));
                    }
                   } 
                
                function getDevicesAndRulList(device,latitude,longtitude){  
                    var duration = 30;  // in mins
                    var url = '/getDeviceLifecyclePredictions?oilRigId='+device+'&latitude='+latitude+'&longtitude='+longtitude+'&durationInMins='+ duration;

                        var devicesData =  $.ajax({
                                type: "GET",
                                url:'/getDeviceLifecyclePredictions?oilRigId='+device+'&latitude='+latitude+'&longtitude='+longtitude+'&durationInMins='+ duration,
                                async: false
                        }).responseText;

                        var myObject = eval('(' + devicesData + ')');
                        return myObject;

                }


                function get_device_lifecycle(){
                    if( deviceName != null ) {
                    var data =  getDevicesAndRulList(deviceName,latitude,longtitude);
                    var chartData = [];
                    var devicesNames = [];
                    rulValues = [];
                    for (var i in data) {
                        var item = data[i];

                        if (typeof item === "object") {
                            for (var j in item) {
                                var temp = [];
                                var myitem = item[j];

                                if (typeof myitem === "object") {
                                    for(var k in myitem){

                        if(k==="name")devicesNames.push(myitem[k]);
                        else if(k==="rulVal")rulValues.push(myitem[k]);
                                       temp.push(myitem[k]);

                        }
                                }

                            }
                       }
                       
                    }
                    for(var l=0;l<  rulValues.length;l++){
                        colorChange(rulValues[l],l);
                    }
                    checkDeviceLife();
                    $(".loader").css('display','none');
                }
            }

                getOilRigs();
                setInterval(get_device_lifecycle,1000*30*1);

                var interval = 1000 * 10 * 1; // where X is your every X minutes
                //setInterval(get_device_lifecycle, interval);
          
            //Area click function added inside ready
            $('.circle').click(function(e) { 
                e.preventDefault();
                $("#chartType").css("display","block");
                $("input:radio:first").prop("checked", true).trigger("click");
                    var titles = [];
                    var unit = 'Unit_1';
                    var max = 270;
                    var target_id = e.target.id;
                    if( target_id == 'a') rulValue = rulValues[0];
                    else if( target_id == 'o') rulValue = rulValues[1];
                    else rulValue = rulValues[2];

                window.location.href = "ChartIndexWithTimegraph.html?dev=" + deviceName + "&id=" + e.target.id + "&rulValue=" + rulValue ;
            }); 


            });

    	function colorRed(id){
            $("#"+id).data('maphilight', {"stroke":0, "alwaysOn": true, "fillColor":"ff0000", "fillOpacity":1}).trigger('alwaysOn.maphilight');
        }
         function colorYellow(id){
            $("#"+id).data('maphilight', {"stroke":0, "alwaysOn": true, "fillColor":"fdd835", "fillOpacity":1}).trigger('alwaysOn.maphilight');
        }
        function colorGreen(id){
            $("#"+id).data('maphilight', {"stroke":0, "alwaysOn": true, "fillColor":"62ce54", "fillOpacity":1}).trigger('alwaysOn.maphilight');

        }

        $('.map').maphilight();
        function checkDeviceLife(){
        $('area').each(function () {
            var elem = $(this),
                map = elem.parent(),
                image = $('img[usemap="#'+map.attr('name')+'"]');
            var data = $(this).data('maphilight') || {};

            var rulvalue = $(this).data('value');
            var circleid = $(this).attr('id');
            
            elem.qtip({
                content: {
                    text: elem.attr('alt') + " , " + rulvalue, // Attempt to grab content from #statesMap-<State> elements first
                    attr: 'alt' // No content? Grab the content from the 'alt' attribute
                },
                position: {
                    viewport: image
                },
                show: {
                    event: 'mouseover',
                    solo: true
                },
                hide: {
                    // Allow the user to hover on the tooltip
                    fixed: true,
                    delay: 200
                },
                style: {
                    classes: 'qtip-tipsy'
                 }
            });
        });
        }//end checkDeviceLife

        function colorChange(rulVal,index){
    	var circleId
    		if(index==0) { 
                circleId='a';
                $("#"+circleId).data('value', rulVal);
            }
    		if(index==1) {
                circleId='o';
                $("#"+circleId).data('value', rulVal);
            }
    		if(index==2) { 
                circleId='n';
                $("#"+circleId).data('value', rulVal);
            }
    
    	if(rulVal>60){
    	
    		colorGreen(circleId);

    	}
        else if(rulVal < 60 && rulVal > 0){
                colorYellow(circleId);
        }
    	else{
    		colorRed(circleId);
    	}
        }

        var guageReading = [];

    </script>
</body>

</html>
