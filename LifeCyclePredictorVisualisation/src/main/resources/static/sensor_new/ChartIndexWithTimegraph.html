<!DOCTYPE html>
<html>

<head>
    <title> Oil Rigs Life Cycle Prediction </title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="js/Chart.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <style>
        #map {
            height: 350px;
            width: 600px;
        }

        html,
        body {
            margin: 0;
            padding: 0;
        }
    </style>
     <!--<style>
	.panel {
	    margin-bottom: 20px;
	    background-color: #fff;
	    border: 1px solid transparent;
	    border-radius: 4px;
	    -webkit-box-shadow: 0 1px 1px rgba(0,0,0,.05);
	    box-shadow: 0 1px 1px rgba(0,0,0,.05);
	}
	.panel-default {
	    border-color: #ddd;
	}
	.panel-default>.panel-heading {
	    color: #333;
	    background-color: #f5f5f5;
	    border-color: #ddd;
	}
	.panel-heading {
	    padding: 10px 15px;
	    border-bottom: 1px solid transparent;
	    border-top-left-radius: 3px;
	    border-top-right-radius: 3px;
	}
	.panel-body {
	    padding: 15px;
	}
	.donutChart {
 	   min-height: 300px;
	}
     </style> -->
</head>
<body style="background:#F2F2F2;">
    <div class="main-container" style="padding:15px;height:600px;">
	<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
	    	<div class="container-fluid">
			<div class="navbar-header">
		    	<a class="navbar-brand" href="/">  Life Cycle Predictions </a>
			</div>
		
	    	</div>
	</div>
        <div style="display:flex;height:350px;margin-bottom:1%;" class="row">
            <div style="width:25%;" id="donutOne" class="donutChart">
		<canvas id="donut1"></canvas>
            </div>
            <div style="width:25%;" id="donutTwo" class="donutChart">
		<canvas id="donut2"></canvas>
            </div>
            <div class="donutChart" style="width:25%;" id="donutThree">
		<canvas id="donut3"></canvas>
            </div>
            <div style="width:25%;" class="donutChart" id="donutFour">
		<canvas id="donut4"></canvas>
            </div>

	</div>
	<div class="row">
            <div class="col-md-12" style="display:flex;">
		<div class="panel panel-default" style="width:50%;margin-right:1%;">
                        <div class="panel-body">
		                <div class="sensor" id="sensorContainer1">
				<canvas id="sensor1"></canvas>
				</div>
			</div>
		</div>
		<div class="panel panel-default" style="width:50%;">
                        <div class="panel-body">
		                <div class="sensor" id="sensorContainer2">
                		<canvas id="sensor2"></canvas>
				</div>
			</div>
		</div>    
           </div>
	   <div class="col-md-12" style="display:flex;" >
		<div class="panel panel-default" style="width:50%;margin-right:1%;">
                        <div class="panel-body">
		                <div class="sensor" id="sensorContainer3">
				<canvas id="sensor3"></canvas>
				</div>    
                        </div>   
                </div>
		<div class="panel panel-default" style="width:50%;">
                        <div class="panel-body">
		                <div class="sensor" id="sensorContainer4">
 				<canvas id="sensor4"></canvas>               	
				</div>    
                        </div>       
                </div>
           </div>
	</div>
  </div>


  <script>
     
  $(document).ready(function(){
      var device = getUrlParameter('dev');
      var id = getUrlParameter('id');
      function showCharts(device,id){
	var guageReading = [];
 	var titles = [];
        var unit = 'Unit_1';
        if(id == 'a'){
                $("#head").html("Crown Block");
                titles = ['Model41',"FP2000",'MLH','SPT'];
                unit = 'Unit_0';
        }
        else if(id == 'o'){
                titles = ['Model41',"IPIS",'MLH','811FM'];
                $("#head").html("Traveling Block");
                unit = 'Unit_1';
        }
        else if(id == 'n'){
                titles = ['FP2000',"811FM",'Model41','MLH']
                $("#head").html("Top Drive");
                unit = 'Unit_0';
        }
        var data = getSensorReadings(device,unit);
	 var chartData = [];
		var sensor_titles = [];
        for (var i in data) {
            var item = data[i];
	//console.log( item );
            var outer = [];

            if (typeof item === "object") {
                for (var j in item) {
			sensor_titles.push(j);
                    var temp = [];
                    var myitem = item[j];
			//console.log( myitem);
                    if (typeof myitem === "object") {
                        for(var k in myitem)
                           temp.push(myitem[k]);
                    }
                    outer.push(item[j]);
                }
           }
           if (outer.length) {
                chartData.push(outer);
           }
        }

        var cData = chartData[0];
        var sensorChartdata = [];
        for(var ind = 0; ind < cData.length; ind++){
                var temp = $.map(cData[ind], function(value, index) {
                    return [value];
                });
                sensorChartdata.push(temp);
        }
//console.log( sensorChartdata);
		var latestVal = [];
        for(var i=0;i<sensorChartdata.length;i++){
		var sensorarray = sensorChartdata[i];
//console.log(sensorarray);

	        var title = sensor_titles[i];
        	var id = 'sensor'+(parseInt(i)+1);
	        var sensorReadings = [];
		var sensorReadingsForChartJs = [];

		var cyclesForChartJS = [];
        	for(var jj =0; jj < sensorarray.length; jj++){
                	//var datas1 = [];
	              //  var Header= ['Range', 'LifeCycleValue'];
        	       // datas1.push(Header);
                	
				cyclesForChartJS.push(jj+1);
				 sensorReadingsForChartJs.push( sensorChartdata[i][jj]);                  
                	      
	                //sensorReadings.push(datas1);
	                //guageReading[jj] = datas1[datas1.length - 1];
			if(jj==(sensorChartdata.length-1)){

				latestVal[i]=sensorChartdata[i][jj];   
			}               
       		}

       		if(i == 0){
                       $("#sensor1").css("cssText","background:url('images/"+titles[i]+".png');background-repeat:no-repeat;backgroud-size:120px 150px;background-position:center;");
                       // google.charts.load('current', {'packages':['corechart']});
                      //  google.charts.setOnLoadCallback(function(){
                  	      	//var chartdata1 = google.visualization.arrayToDataTable(sensorReadings[0]);       
				//drawChart1(sensor_titles[0],chartdata1,"sensor1")
			//drawLineGraphForSensors(cyclesForChartJS,sensorReadingsForChartJs,"sensor1");
				
			//});
						drawLineGraphForSensorsOne(cyclesForChartJS,sensorReadingsForChartJs,"sensor1");

			google.charts.load('current', {'packages':['corechart']});
			google.charts.setOnLoadCallback(function(){drawDonutChartUsingChartJS(sensor_titles[0],"donut1",latestVal[0],700)});
                }
                else if(i == 1){
					//console.log(latestVal);
                      $("#sensor2").css("cssText","background:url('images/"+titles[i]+".png');background-repeat:no-repeat;backgroud-size:300px 200px;background-position:center;");
                        //google.charts.load('current', {'packages':['corechart']});
                        //google.charts.setOnLoadCallback(function(){
	                      	//var chartdata2 = google.visualization.arrayToDataTable(sensorReadings[1]);        
				//drawChart1(sensor_titles[1],chartdata2,"sensor2")
			//});
						drawLineGraphForSensorsTwo(cyclesForChartJS,sensorReadingsForChartJs,"sensor2");			
			google.charts.load('current', {'packages':['corechart']});
                        google.charts.setOnLoadCallback(function(){drawDonutChartUsingChartJS(sensor_titles[1],"donut2",latestVal[1],70)});
                }
                else if(i == 2){
					//console.log(latestVal);
                       $("#sensor3").css("cssText","background:url('images/"+titles[i]+".png');background-repeat:no-repeat;backgroud-size:300px 200px;background-position:center;");
				drawLineGraphForSensorsThree(cyclesForChartJS,sensorReadingsForChartJs,"sensor3");                       
			google.charts.load('current', {'packages':['corechart']});
                        google.charts.setOnLoadCallback(function(){drawDonutChartUsingChartJS(sensor_titles[2],"donut3",latestVal[2],10000)});
                }
                else if(i == 3){
					//console.log(latestVal);
                       $("#sensor4").css("cssText","background:url('images/"+titles[i]+".png');background-repeat:no-repeat;backgroud-size:300px 200px;background-position:center;");
			drawLineGraphForSensorsFour(cyclesForChartJS,sensorReadingsForChartJs,"sensor4");                                               
			google.charts.load('current', {'packages':['corechart']});
                        google.charts.setOnLoadCallback(function(){drawDonutChartUsingChartJS(sensor_titles[3],"donut4",latestVal[3],1500)});
                }
//console.log(sensorReadingsForChartJs);
	cyclesForChartJS = [];
	sensorReadingsForChartJs = [];
         }
     }

    function drawChart1(title,data,id) {
//console.log( data );
          var options = {
	       backgroundColor: 'none',
	       title: title,
	       curveType: 'function',
	       legend: { position: 'bottom' },
	       /*hAxis: {
			textStyle:{color: '#FFF'},
	        	maxValue: max
	       },
	       vAxis: {
       			textStyle:{color: '#FFF'}
               }*/
         };
         var chart = new google.visualization.LineChart(document.getElementById(id));
         chart.draw(data, options);
    }
  
     function drawDonutChartUsingChart(title,id,donutvalue) {
        var percentage = Math.ceil(donutvalue / 50)+1;
        var donutpercentage = Math.ceil(donutvalue/percentage);
        var remining = 50 - donutpercentage;
        var data = google.visualization.arrayToDataTable([
                   ['Task', 'Hours per Day'],
        	   ['', 50],
		   ['', donutpercentage],
		   ['', remining]
        ]);
      
        var options = {
                 title: "",
	        legend:"none",
        	slices: {
	            0: {
        	        color: 'transparent',
                	enableInteractivity: false
            	   },
	           2: {
        	        color:"#d3d3d3",
                	enableInteractivity: false
	            },
        	  pieSliceText: 'none',
	        },
        	pieHole: 0.5,
	        pieStartAngle: 90
        };

        var chart = new google.visualization.PieChart(document.getElementById(id));
        chart.draw(data, options);
    }

function drawDonutChartUsingChartJS(title,id,donutvalue,Max_value){

var data1 = {
        labels: ["Current Reading"],
        datasets: [
            {
                data: [donutvalue, Max_value - donutvalue ],
                backgroundColor: [
                    "#ef5350",
                    "#D3D3D3"
                ],
                /*borderColor: [
                    "#CDA776",
                    "#989898",
                ],*/
		hoverBackgroundColor: [
                        "#b61827",
                        "#D3D3D3"
                ],
                borderWidth: [1, 1]
            }
        ]
    };

	var options = {
        responsive: true,
	animation: {
                animateRotate: true,
                animateScale: true,
                animateRotate : true,
        }, 
	rotation: 3/4 * Math.PI,
        circumference: (3/2) * Math.PI, 
        title: {
            display: true,
            position: "top",
            text: title,
            fontSize: 18,
            fontColor: "#111"
        },
        legend: {
            display: true,
            position: "bottom",
            labels: {
                fontColor: "#333",
                fontSize: 16
            }
        }
    };
	
	//create Chart class object
    var chart1 = new Chart(id, {
        type: "doughnut",
        data: data1,
        options: options
    });

}
 
//Live Temp graph
	function drawLineGraphForSensorsOne(cycles,readings,canvasId){
//console.log(readings);
 // get chart canvas
	var tempData = {
            labels:cycles,
            datasets: [
                {
                    label: "Current",
                    fill: false,
                    lineTension: 0.1,
                    backgroundColor: "#ef5350",
                    borderColor: "#b61827",
                    borderCapStyle: 'butt',
                    borderDash: [],
                    borderDashOffset: 0.0,
                    borderJoinStyle: 'miter',
                    pointBorderColor: "#b61827",
                    pointBackgroundColor: "#fff",
                    pointBorderWidth: 0,
                    pointHoverRadius: 5,
                    pointHoverBackgroundColor: "#b61827",
                    pointHoverBorderColor: "rgba(220,220,220,1)",
                    pointHoverBorderWidth: 2,
                    pointRadius: 0,
                    pointHitRadius: 10,
                    data :readings ,
                    spanGaps: false
                }
            ]
        };
        var tempChart = new Chart(document.getElementById(canvasId), {
            type: 'line',
            data: tempData,
            options: {
                tooltips: {
                    mode: 'index',
                    intersect: false
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                }
            }
        });
}
function drawLineGraphForSensorsTwo(cycles,readings,canvasId){
console.log(readings);
 // get chart canvas
	var tempData = {
            labels:cycles,
            datasets: [
                {
                    label: "Current",
                    fill: false,
                    lineTension: 0.1,
                    backgroundColor: "#ef5350",
                    borderColor: "#b61827",
                    borderCapStyle: 'butt',
                    borderDash: [],
                    borderDashOffset: 0.0,
                    borderJoinStyle: 'miter',
                    pointBorderColor: "#b61827",
                    pointBackgroundColor: "#fff",
                    pointBorderWidth: 0,
                    pointHoverRadius: 5,
                    pointHoverBackgroundColor: "#b61827",
                    pointHoverBorderColor: "rgba(220,220,220,1)",
                    pointHoverBorderWidth: 2,
                    pointRadius: 0,
                    pointHitRadius: 10,
                    data :readings ,
                    spanGaps: false
                }
            ]
        };
        var tempChart = new Chart(document.getElementById(canvasId), {
            type: 'line',
            data: tempData,
            options: {
                tooltips: {
                    mode: 'index',
                    intersect: false
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                }
            }
        });
}

function drawLineGraphForSensorsThree(cycles,readings,canvasId){
 // get chart canvas
	var tempData = {
            labels:cycles,
            datasets: [
                {
                    label: "Current",
                    fill: false,
                    lineTension: 0.1,
                    backgroundColor: "#ef5350",
                    borderColor: "#b61827",
                    borderCapStyle: 'butt',
                    borderDash: [],
                    borderDashOffset: 0.0,
                    borderJoinStyle: 'miter',
                    pointBorderColor: "#b61827",
                    pointBackgroundColor: "#fff",
                    pointBorderWidth: 0,
                    pointHoverRadius: 5,
                    pointHoverBackgroundColor: "#b61827",
                    pointHoverBorderColor: "rgba(220,220,220,1)",
                    pointHoverBorderWidth: 2,
                    pointRadius: 0,
                    pointHitRadius: 10,
                    data :readings ,
                    spanGaps: false
                }
            ]
        };
        var tempChart = new Chart(document.getElementById(canvasId), {
            type: 'line',
            data: tempData,
            options: {
                tooltips: {
                    mode: 'index',
                    intersect: false
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                }
            }
        });
}

function drawLineGraphForSensorsFour(cycles,readings,canvasId){
 // get chart canvas
	var tempData = {
            labels:cycles,
            datasets: [
                {
                    label: "Current",
                    fill: false,
                    lineTension: 0.1,
                    backgroundColor: "#ef5350",
                    borderColor: "#b61827",
                    borderCapStyle: 'butt',
                    borderDash: [],
                    borderDashOffset: 0.0,
                    borderJoinStyle: 'miter',
                    pointBorderColor: "#b61827",
                    pointBackgroundColor: "#fff",
                    pointBorderWidth: 0,
                    pointHoverRadius: 5,
                    pointHoverBackgroundColor: "#b61827",
                    pointHoverBorderColor: "rgba(220,220,220,1)",
                    pointHoverBorderWidth: 2,
                    pointRadius: 0,
                    pointHitRadius: 10,
                    data :readings ,
                    spanGaps: false
                }
            ]
        };
        var tempChart = new Chart(document.getElementById(canvasId), {
            type: 'line',
            data: tempData,
            options: {
                tooltips: {
                    mode: 'index',
                    intersect: false
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                }
            }
        });
}
        
        
       
        

    function getUrlParameter(sParam) {
        var sPageURL = decodeURIComponent(window.location.search.substring(1)),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;
        for (i = 0; i < sURLVariables.length; i++) {
                sParameterName = sURLVariables[i].split('=');
                if (sParameterName[0] === sParam) {
                    return sParameterName[1] === undefined ? true : sParameterName[1];
                }
        }
   };
  
   function getSensorReadings(device,unit){ 
	var duration = 12*60;//in mins   
                var sensordata =  $.ajax({
                        type: "GET",
                        url:'http://localhost:8080/getSensorReadingsForDevice?deviceId='+unit+'&industrialPlantId='+device+'&durationInMins='+ duration,
                        async: false
                }).responseText;
                var myObject = eval('(' + sensordata + ')');
                return myObject;
   }


	setInterval(function(){showCharts(device,id);},30000); // Time in milliseconds

      showCharts(device,id);
	

  });
    </script>
</body>
</html>
